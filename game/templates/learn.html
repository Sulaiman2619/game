{% load static tailwind_tags %}

<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ù‡∏∂‡∏Å‡∏≠‡πà‡∏≤‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£</title>
    {% tailwind_css %}
</head>
<body class="flex flex-col items-center justify-center min-h-screen bg-gray-100 p-4">
    <h2 class="text-2xl font-bold text-gray-700">‡∏ù‡∏∂‡∏Å‡∏≠‡πà‡∏≤‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£</h2>

    <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ -->
    <div id="letterDisplay" class="text-9xl font-bold text-blue-600  cursor-pointer"></div>

    <button id="recordButton" class="mt-10 px-4 py-2 bg-red-500 text-white rounded-lg shadow-md hover:bg-red-600">
        üî¥ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á
    </button>

    <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏ñ‡∏±‡∏î‡πÑ‡∏õ -->
    <div class="flex justify-end w-[80%] 2xl:w-[50%]">
        <button id="nextLetter" class="mt-10 px-4 py-2 bg-green-500 text-white rounded-lg shadow-md hover:bg-green-600">
            ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
        </button>
    </div>

    <script>
        let alphabetData = [];
        let currentIndex = 0;
        let mediaRecorder; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ global
        let audioChunks = []; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ global

        async function fetchAlphabet() {
            try {
                let response = await fetch('/api/alphabets/');
                if (!response.ok) throw new Error("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß");
                alphabetData = await response.json();
                if (alphabetData.length > 0) {
                    showLetter();
                } else {
                    alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö");
                }
            } catch (error) {
                console.error(error);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
            }
        }

        function showLetter() {
            if (alphabetData.length > 0) {
                let letterInfo = alphabetData[currentIndex];
                let letterElement = document.getElementById("letterDisplay");
                letterElement.innerText = letterInfo.letter;
            }
        }

        function playSound() {
            if (alphabetData.length === 0) return;
            let letterInfo = alphabetData[currentIndex];

            let audioUrl = letterInfo.pronunciation_audio;

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ audioUrl ‡πÄ‡∏õ‡πá‡∏ô URL ‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô path
            if (!audioUrl.startsWith("http")) {
                audioUrl = `/media/${audioUrl}`;
            }

            console.log("‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô:", audioUrl);

            let audio = new Audio(audioUrl);
            audio.play().catch(error => console.error("‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", error));
        }

        async function startRecording() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];

            mediaRecorder.ondataavailable = event => {
                audioChunks.push(event.data);
            };

            mediaRecorder.onstop = async () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                const formData = new FormData();
                formData.append("audio", audioBlob, "recording.webm");
                formData.append("letter_id", alphabetData[currentIndex].id);  // ‡∏™‡πà‡∏á letter_id ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢

                try {
                    let response = await fetch("/api/upload_audio/", {
                        method: "POST",
                        body: formData
                    });

                    let result = await response.json();
                    if (result.similarity !== undefined) {
                        alert(`‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏Ñ‡∏•‡∏∂‡∏á‡∏Å‡∏±‡∏ô: ${result.similarity}`);
                    } else {
                        alert(result.message);
                    }
                } catch (error) {
                    console.error("‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", error);
                    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á");
                }

                document.getElementById("recordButton").innerText = "üî¥ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á";
            };

            mediaRecorder.start();
            document.getElementById("recordButton").innerText = "‚èπ ‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å";
        } catch (error) {
            console.error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô:", error);
            alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô");
        }
    }


        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== "inactive") {
                mediaRecorder.stop();
            }
        }

        document.getElementById("letterDisplay").addEventListener("click", playSound);

        document.getElementById("nextLetter").addEventListener("click", () => {
            if (alphabetData.length === 0) return;
            currentIndex = (currentIndex + 1) % alphabetData.length;
            showLetter();
        });

        document.getElementById("recordButton").addEventListener("click", () => {
            if (!mediaRecorder || mediaRecorder.state === "inactive") {
                startRecording();
            } else {
                stopRecording();
            }
        });

        fetchAlphabet();
    </script>
</body>
</html>
